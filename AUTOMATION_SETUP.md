# ‚è∞ Configuration de l'Automatisation Quotidienne

## üéØ Objectif

Mettre en place une mise √† jour automatique des prix de vos actifs **tous les jours √† 8h UTC** (10h Paris en hiver) via GitHub Actions.

### Avantages de GitHub Actions
- ‚úÖ **100% gratuit** (dans les limites d'utilisation)
- ‚úÖ **Aucun serveur √† g√©rer**
- ‚úÖ **Ex√©cution fiable et automatique**
- ‚úÖ **Logs d√©taill√©s** de chaque ex√©cution
- ‚úÖ **D√©clenchement manuel** possible depuis l'interface GitHub

---

## üìã Pr√©requis

Avant de commencer, assurez-vous d'avoir :

1. ‚úÖ Un compte GitHub
2. ‚úÖ Votre projet Finarian push√© sur GitHub
3. ‚úÖ Un utilisateur Supabase cr√©√© (via l'application)
4. ‚úÖ Des actifs avec symboles Yahoo Finance
5. ‚úÖ La fonction Edge `update-prices` d√©ploy√©e

---

## üöÄ Installation - √âtape par √©tape

### √âtape 1 : Pusher le workflow sur GitHub

Le fichier `.github/workflows/daily-price-update.yml` a √©t√© cr√©√©. Il faut maintenant le pousser sur GitHub :

```bash
cd /Users/jekmekdijan/Documents/Finarian

# Ajouter les fichiers
git add .github/workflows/daily-price-update.yml
git add scripts/test-cron.sh

# Commit
git commit -m "feat: Add automated daily price updates with GitHub Actions"

# Push
git push origin main
```

### √âtape 2 : Configurer les secrets GitHub

Les secrets permettent de stocker de mani√®re s√©curis√©e vos identifiants.

1. **Allez sur votre d√©p√¥t GitHub** : `https://github.com/VOTRE_USERNAME/finarian`

2. **Cliquez sur "Settings"** (‚öôÔ∏è en haut √† droite)

3. **Dans le menu de gauche** : 
   - Cliquez sur **"Secrets and variables"**
   - Puis sur **"Actions"**

4. **Ajoutez les 4 secrets suivants** (bouton "New repository secret") :

| Nom du secret | Valeur | O√π la trouver |
|---------------|--------|---------------|
| `SUPABASE_URL` | `https://XXXX.supabase.co` | Fichier `.env` ‚Üí `VITE_SUPABASE_URL` |
| `SUPABASE_ANON_KEY` | `eyJhbGc...` (long token) | Fichier `.env` ‚Üí `VITE_SUPABASE_KEY` |
| `SUPABASE_USER_EMAIL` | `votre-email@example.com` | Email utilis√© pour vous connecter √† l'app |
| `SUPABASE_USER_PASSWORD` | `votre-mot-de-passe` | Mot de passe de votre compte |

**‚ö†Ô∏è Important :** Utilisez un compte utilisateur **existant** dans Supabase Auth. Le workflow s'authentifiera avec ce compte pour appeler la fonction Edge.

### √âtape 3 : V√©rifier la configuration

Une fois les secrets configur√©s :

1. Allez dans l'onglet **"Actions"** de votre d√©p√¥t GitHub
2. Vous devriez voir le workflow **"Daily Price Update"** dans la liste
3. Cliquez dessus

### √âtape 4 : Test manuel

Avant d'attendre le premier run automatique, testez manuellement :

1. Dans l'onglet **Actions**, cliquez sur **"Daily Price Update"**
2. Cliquez sur le bouton **"Run workflow"** (√† droite)
3. S√©lectionnez la branche `main`
4. Cliquez sur **"Run workflow"** (bouton vert)
5. Attendez ~30 secondes
6. Le workflow devrait appara√Ætre avec un ‚úÖ (succ√®s) ou ‚ùå (√©chec)

### √âtape 5 : Consulter les logs

1. Cliquez sur l'ex√©cution du workflow
2. Cliquez sur le job **"update-prices"**
3. Consultez les logs d√©taill√©s :
   - Authentification r√©ussie ?
   - Fonction Edge appel√©e ?
   - Combien de prix mis √† jour ?
   - Y a-t-il des erreurs ?

---

## üß™ Test local (optionnel)

Avant de configurer GitHub Actions, vous pouvez tester localement avec le script fourni.

### 1. Configurer les variables d'environnement

Ajoutez √† votre fichier `.env` :

```env
# Variables existantes
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_KEY=your-anon-key

# Nouvelles variables pour le test
TEST_USER_EMAIL=votre-email@example.com
TEST_USER_PASSWORD=votre-mot-de-passe
```

### 2. Ex√©cuter le script de test

```bash
./scripts/test-cron.sh
```

Vous devriez voir :

```
üß™ Testing automated price update...
==================================

üìÇ Loading environment variables from .env...
‚úÖ Environment variables loaded

üîê Step 1: Authenticating user...
‚úÖ Authentication successful
üéüÔ∏è  Token: eyJhbGciOiJIUzI1NiIs...

üîÑ Step 2: Calling update-prices function...
üìä HTTP Status: 200

üìã Response:
---
{
  "message": "Price update completed",
  "updated": 5,
  "failed": 0,
  "details": { ... }
}
---

‚úÖ Test successful! Prices updated.
üìà Updated: 5 asset(s)

üéâ The automated update is working correctly!
üí° You can now enable the GitHub Actions workflow.
```

---

## üìÖ Planification

### Horaire par d√©faut

Le workflow est configur√© pour s'ex√©cuter **tous les jours √† 8h UTC** :

```yaml
schedule:
  - cron: '0 8 * * *'  # minute heure jour mois jour_semaine
```

**Conversions** :
- üá´üá∑ **Paris** : 10h (hiver) / 9h (√©t√©)
- üá¨üáß **Londres** : 8h (hiver) / 9h (√©t√©)
- üá∫üá∏ **New York** : 3h (hiver) / 4h (√©t√©)

### Modifier l'horaire

Pour changer l'heure, √©ditez le fichier `.github/workflows/daily-price-update.yml` :

```yaml
# Exemples de configurations

# Tous les jours √† 7h UTC (9h Paris hiver)
- cron: '0 7 * * *'

# Tous les jours √† 12h UTC (14h Paris hiver)
- cron: '0 12 * * *'

# Deux fois par jour (8h et 18h UTC)
schedule:
  - cron: '0 8 * * *'
  - cron: '0 18 * * *'

# Seulement les jours de semaine (lundi-vendredi)
- cron: '0 8 * * 1-5'

# Toutes les heures (de 8h √† 18h UTC)
- cron: '0 8-18 * * *'
```

**Format cron** : `minute heure jour mois jour_semaine`
- `*` = tous
- `1-5` = du lundi au vendredi
- `8-18` = de 8h √† 18h

---

## üìä Monitoring et logs

### Consulter l'historique des ex√©cutions

1. Allez dans l'onglet **"Actions"** sur GitHub
2. Cliquez sur **"Daily Price Update"**
3. Vous verrez la liste de toutes les ex√©cutions :
   - ‚úÖ Succ√®s (vert)
   - ‚ùå √âchec (rouge)
   - üü° En cours (jaune)

### Analyser une ex√©cution

Cliquez sur une ex√©cution pour voir :
- **Dur√©e** de l'ex√©cution
- **Logs d√©taill√©s** de chaque √©tape
- **Nombre d'actifs** mis √† jour
- **Erreurs** √©ventuelles

### Notifications par email

GitHub envoie automatiquement un email si :
- Le workflow √©choue pour la premi√®re fois
- Le workflow r√©ussit apr√®s avoir √©chou√©

Pour configurer les notifications :
1. **Settings** ‚Üí **Notifications** (votre profil GitHub)
2. Section **"Actions"**
3. Cochez **"Send notifications for failed workflows"**

---

## üõ†Ô∏è D√©pannage

### Probl√®me 1 : "Authentication failed"

**Sympt√¥me** : Le workflow √©choue avec "‚ùå Authentication failed"

**Causes possibles** :
1. Email ou mot de passe incorrect dans les secrets GitHub
2. L'utilisateur n'existe pas dans Supabase Auth
3. Le compte est d√©sactiv√©

**Solutions** :
1. V√©rifiez que vous pouvez vous connecter √† l'application avec ces identifiants
2. Allez dans **Settings ‚Üí Secrets** sur GitHub et v√©rifiez les secrets
3. Recr√©ez les secrets si n√©cessaire

### Probl√®me 2 : "Price update failed"

**Sympt√¥me** : Authentification OK mais mise √† jour √©choue

**Causes possibles** :
1. La fonction Edge `update-prices` n'est pas d√©ploy√©e
2. Erreur dans la fonction Edge
3. Probl√®me de RLS (Row Level Security) dans Supabase

**Solutions** :
1. V√©rifiez que la fonction Edge existe dans Supabase
2. Testez manuellement depuis l'application
3. Consultez les logs de la fonction Edge dans Supabase

### Probl√®me 3 : "No assets with symbols found"

**Sympt√¥me** : Le workflow r√©ussit mais 0 actifs mis √† jour

**Causes possibles** :
1. Aucun actif avec un symbole Yahoo Finance
2. L'utilisateur n'a pas d'actifs

**Solutions** :
1. Connectez-vous √† l'application
2. Ajoutez des symboles √† vos actifs (ex: AAPL, BTC-USD)
3. Relancez le workflow manuellement

### Probl√®me 4 : Le workflow ne s'ex√©cute pas automatiquement

**Sympt√¥me** : Aucune ex√©cution automatique (scheduled)

**Causes possibles** :
1. Le d√©p√¥t est priv√© et inactif depuis 60 jours
2. Le workflow est d√©sactiv√©
3. Erreur de syntaxe dans le cron

**Solutions** :
1. Faites un commit/push pour "r√©veiller" le d√©p√¥t
2. V√©rifiez que le workflow est activ√© (onglet Actions)
3. D√©clenchez manuellement pour v√©rifier

### Probl√®me 5 : "Invalid or expired token"

**Sympt√¥me** : Token d'authentification invalide

**Causes possibles** :
1. Le mot de passe a √©t√© chang√©
2. L'utilisateur a √©t√© supprim√©
3. Session expir√©e

**Solutions** :
1. Mettez √† jour le secret `SUPABASE_USER_PASSWORD`
2. V√©rifiez que le compte existe toujours
3. Relancez le workflow

---

## üîí S√©curit√©

### Bonnes pratiques

‚úÖ **√Ä faire** :
- Utilisez les secrets GitHub (jamais de credentials en dur)
- Utilisez un compte d√©di√© si possible (ex: `bot@finarian.com`)
- Changez r√©guli√®rement le mot de passe
- Surveillez les logs d'ex√©cution
- D√©sactivez le workflow si vous ne l'utilisez plus

‚ùå **√Ä √©viter** :
- Ne commitez JAMAIS les credentials dans le code
- N'utilisez pas votre compte personnel principal
- Ne partagez pas les secrets
- Ne laissez pas le workflow actif sur un d√©p√¥t public avec des credentials

### Compte utilisateur d√©di√© (recommand√©)

Pour plus de s√©curit√©, cr√©ez un compte utilisateur sp√©cifique pour le bot :

1. Cr√©ez un nouveau compte : `bot@votre-domaine.com`
2. Connectez-vous avec ce compte dans l'application
3. Assurez-vous qu'il a acc√®s aux actifs (via RLS)
4. Utilisez ces credentials dans les secrets GitHub

---

## üìà Optimisations avanc√©es

### Ex√©cution conditionnelle

Ex√©cuter seulement les jours de semaine (√©viter weekends) :

```yaml
schedule:
  - cron: '0 8 * * 1-5'  # Lundi √† vendredi seulement
```

### Notifications Slack/Discord (optionnel)

Ajoutez une √©tape pour envoyer une notification :

```yaml
- name: Send notification
  if: success()
  run: |
    curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
      -H 'Content-Type: application/json' \
      -d '{"text":"‚úÖ Prices updated successfully!"}'
```

### Retry en cas d'√©chec

Ajoutez un retry automatique :

```yaml
- name: Call Supabase Edge Function
  uses: nick-invision/retry@v2
  with:
    timeout_minutes: 5
    max_attempts: 3
    command: |
      # ... votre commande curl
```

---

## üìä Statistiques d'utilisation

### Limites GitHub Actions (compte gratuit)

- **2 000 minutes/mois** pour les d√©p√¥ts priv√©s
- **Illimit√©** pour les d√©p√¥ts publics
- Ce workflow utilise **~1 minute/jour** = **30 minutes/mois**

### Surveillance de l'utilisation

1. **GitHub** ‚Üí **Settings** ‚Üí **Billing**
2. Section **"Actions"**
3. Consultez les minutes utilis√©es

---

## üîÆ Alternatives

Si GitHub Actions ne convient pas, voici d'autres options :

### 1. Supabase Cron (√† venir)
Supabase pr√©voit d'ajouter des cron jobs natifs. Surveillez les annonces.

### 2. Services externes
- **cron-job.org** (gratuit, simple)
- **EasyCron** (gratuit avec limitations)
- **Zapier** (payant, tr√®s visuel)

### 3. Serveur personnel
Si vous avez un serveur Linux :

```bash
# Ajouter au crontab
0 8 * * * /path/to/scripts/test-cron.sh
```

---

## ‚úÖ Checklist de v√©rification

Avant de consid√©rer la configuration termin√©e :

- [ ] Workflow push√© sur GitHub
- [ ] 4 secrets configur√©s (URL, KEY, EMAIL, PASSWORD)
- [ ] Test manuel r√©ussi
- [ ] Logs consult√©s et valid√©s
- [ ] Au moins 1 actif avec symbole
- [ ] Historique actif dans la base de donn√©es
- [ ] Notifications configur√©es (optionnel)
- [ ] Documentation lue et comprise

---

## ‚ùì FAQ

**Q : Le workflow compte dans mon quota GitHub ?**  
R : Oui, mais il utilise seulement ~1 minute/jour. Pour un compte gratuit (2000 min/mois), c'est largement suffisant.

**Q : Puis-je ex√©cuter plusieurs fois par jour ?**  
R : Oui ! Ajoutez plusieurs lignes cron dans le schedule. Mais attention : Yahoo Finance peut limiter si vous appelez trop souvent.

**Q : Le workflow fonctionne sur un d√©p√¥t priv√© ?**  
R : Oui, mais les minutes sont comptabilis√©es (2000/mois gratuit).

**Q : Que se passe-t-il si mon mot de passe change ?**  
R : Le workflow √©chouera. Mettez √† jour le secret `SUPABASE_USER_PASSWORD` sur GitHub.

**Q : Puis-je d√©sactiver temporairement l'automatisation ?**  
R : Oui. Allez dans Actions ‚Üí Daily Price Update ‚Üí "..." ‚Üí Disable workflow.

**Q : Les prix sont-ils garantis d'√™tre √† jour ?**  
R : Non. Yahoo Finance peut avoir des d√©lais ou √™tre indisponible. C'est pourquoi on garde un bouton manuel dans l'app.

**Q : Comment savoir si √ßa a fonctionn√© ce matin ?**  
R : Allez dans l'onglet Actions sur GitHub, ou consultez l'historique dans votre base de donn√©es.

---

## üéâ R√©sultat attendu

Une fois configur√©, chaque matin :

1. ‚è∞ **8h00 UTC** : GitHub Actions se d√©clenche
2. üîê **Authentification** : Connexion avec votre compte
3. üîÑ **Mise √† jour** : Appel de la fonction Edge
4. üìä **Historique** : Nouveau point de donn√©es dans `asset_history`
5. üìà **Graphiques** : Mise √† jour automatique dans l'application
6. ‚úÖ **Notification** : Email de GitHub (si configur√©)

**Vous n'avez plus rien √† faire !** üéä

---

**Automatisation configur√©e et fonctionnelle ! ‚è∞‚ú®**

